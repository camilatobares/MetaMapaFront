<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle='Administración', content=~{::#main-content}, pageScripts=~{::#page-scripts})}">
    <body>
        <main id="main-content">
            <div class="container-fluid p-4 animate__animated animate__fadeIn" >
                <div class="card shadow-lg border-0 rounded-3">
                    <div class="card-header bg-primary text-white border-bottom-0 p-4 rounded-top-3"><h3 class="fw-bold mb-0">Panel de Administración</h3></div>
                    <div class="card-body p-4">

                        <div id="alert-placeholder">
                            <div th:if="${success}" class="alert alert-success d-flex align-items-center" role="alert">
                                <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                                <span th:text="${success}"></span>
                            </div>
                            <div th:if="${error}" class="alert alert-danger d-flex align-items-center" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                                <span th:text="${error}"></span>
                            </div>
                        </div>

                        <ul class="nav nav-pills nav-justified mb-4">
                            <li class="nav-item"><button id="admin-tab-collections" class="nav-link active">Gestionar Colecciones</button></li>
                            <li class="nav-item"><button id="admin-tab-requests" class="nav-link">Revisar Solicitudes</button></li>
                        </ul>

                        <div id="admin-tab-content-wrapper">

                            <div id="collections-content">
                                <div class="d-flex gap-2 mb-4">
                                    <a th:href="@{/admin/colecciones/nueva}" class="btn btn-success rounded-pill px-4 fw-bold">+ Nueva Colección</a>
                                    <button type="button" class="btn btn-info rounded-pill px-4 fw-bold text-white" data-bs-toggle="modal" data-bs-target="#csvImportModal">
                                        <i class="bi bi-upload me-2"></i>Importar CSV
                                    </button>
                                    <a th:href="@{/admin/estadisticas}" class="btn btn-warning rounded-pill px-4 fw-bold text-dark"><i class="bi bi-graph-up me-2"></i> Ver Estadísticas</a>
                                </div>

                                <div class="table-responsive rounded-3 overflow-hidden shadow-sm">
                                    <div th:if="${#lists.isEmpty(colecciones)}" class="text-center text-muted p-5">No hay colecciones para gestionar.</div>
                                    <table th:unless="${#lists.isEmpty(colecciones)}" class="table table-striped table-hover mb-0">
                                        <thead class="bg-light">
                                        <tr>
                                            <th class="text-secondary fw-bold">Título</th>
                                            <th class="text-secondary fw-bold">Fuente</th>
                                            <th class="text-end text-secondary fw-bold">Acciones</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="col : ${colecciones}">
                                            <td th:text="${col.titulo}"></td>
                                            <td><span class="badge bg-secondary">Carga Manual</span></td>
                                            <td class="text-end">
                                                <a th:href="@{/admin/colecciones/{id}/editar(id=${col.handleID})}" class="btn btn-primary btn-sm rounded-pill">Editar Colección</a>
                                                <form th:action="@{/admin/colecciones/{id}/eliminar(id=${col.handleID})}"
                                                      method="post"
                                                      class="d-inline">
                                                    <button type="button" class="btn btn-danger btn-sm rounded-pill" onclick="confirmarEliminacion(this)">
                                                        <i class="bi bi-trash"></i> Eliminar
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="requests-content" style="display: none;">
                                <div class="card card-body mb-3 bg-light border-0">
                                    <div class="row g-3 align-items-center">
                                        <div class="col-md-6">
                                            <label class="form-label small">Filtrar por tipo</label>
                                            <select class="form-select form-select-sm" id="admin-filter-type">
                                                <option value="">Todos</option>
                                                <option value="Nuevo Hecho">Nuevo Hecho</option>
                                                <option value="Eliminación">Eliminación</option>
                                                <option value="Edición">Edición</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Filtrar por estado</label>
                                            <select class="form-select form-select-sm" id="admin-filter-status">
                                                <option value="">Todos</option>
                                                <option value="PENDIENTE">Pendiente</option>
                                                <option value="APROBADA">Aceptado</option>
                                                <option value="RECHAZADA">Rechazado</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="table-responsive rounded-3 overflow-hidden shadow-sm">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="bg-light">
                                        <tr>
                                            <th class="text-secondary fw-bold">Título</th>
                                            <th class="text-secondary fw-bold">Tipo</th>
                                            <th class="text-secondary fw-bold">Estado</th>
                                            <th class="text-end text-secondary fw-bold">Acciones</th>
                                        </tr>
                                        </thead>
                                        <tbody id="admin-requests-table-body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="evaluationModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title fw-bold" id="modalTitle">Evaluación</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div id="modalContent">Cargando...</div>
                                <!-- Textarea para sugerencia -->
                                <div id="sugerencia-container" class="mt-3" style="display:none;">
                                    <label for="inputSugerencia" class="form-label fw-bold">Sugerencia del admin</label>
                                    <textarea id="inputSugerencia" class="form-control" maxlength="1000" rows="3" placeholder="Escriba la sugerencia..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer bg-light">
                                <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>

                                <form id="formReject" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-danger rounded-pill fw-bold px-4">
                                        <i class="bi bi-x-circle me-2"></i>Rechazar
                                    </button>
                                </form>

                                <form id="formApprove" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-success rounded-pill fw-bold px-4">
                                        <i class="bi bi-check-circle me-2"></i>Aceptar
                                    </button>
                                </form>

                                <form id="formApproveWithSuggestion" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-warning rounded-pill fw-bold px-4">
                                        <i class="bi bi-lightbulb me-2"></i>Aceptar con Sugerencia
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-4">
                            <div class="modal-header border-bottom-0 pb-0">
                                <h5 class="modal-title fw-bold text-danger">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar Eliminación
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body py-4 text-center">
                                <p class="fs-5 text-muted">¿Estás seguro de que quieres eliminar esta colección?</p>
                                <p class="small text-secondary mb-0">Esta acción no se puede deshacer y eliminará las referencias en el sistema.</p>
                            </div>
                            <div class="modal-footer border-top-0 justify-content-center gap-2 pb-4">
                                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" id="btn-confirm-delete" class="btn btn-danger rounded-pill px-4 fw-bold">
                                    Sí, Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>



        <div id="page-scripts">
            <script th:inline="javascript">
                /*<![CDATA[*/
                const allCollections = /*[[${colecciones}]]*/ [];
                const allRequests = /*[[${solicitudes}]]*/ [];
                const GLOBAL_BACKEND_URL = /*[[${backendImagesUrl}]]*/ 'http://localhost:8082';
                /*]]>*/
            </script>
            <script>
                let formToDeleteGlobal = null;
                let deleteModalInstance = null;

                // Esta función la llama el botón HTML directamente. ¡No falla!
                function confirmarEliminacion(boton) {
                    // 1. Guardamos el formulario padre del botón que se clickeó
                    formToDeleteGlobal = boton.closest('form');

                    // 2. Inicializamos el modal si no existe
                    const modalEl = document.getElementById('deleteConfirmModal');
                    if (modalEl) {
                        if (!deleteModalInstance) {
                            deleteModalInstance = new bootstrap.Modal(modalEl);
                        }
                        deleteModalInstance.show();
                    } else {
                        console.error("No se encontró el modal 'deleteConfirmModal'");
                    }
                }

                document.addEventListener('DOMContentLoaded', () => {
                    renderSidebar('admin');

                    const btnConfirmDelete = document.getElementById('btn-confirm-delete');
                    if (btnConfirmDelete) {
                        btnConfirmDelete.addEventListener('click', function() {
                            if (formToDeleteGlobal) {
                                formToDeleteGlobal.submit(); // Enviamos el formulario manualmente
                            }
                            if (deleteModalInstance) {
                                deleteModalInstance.hide();
                            }
                        });
                    }

                    // --- TABS Y FILTROS (Sin cambios) ---
                    const tabCollections = document.getElementById('admin-tab-collections');
                    const tabRequests = document.getElementById('admin-tab-requests');
                    const contentCollections = document.getElementById('collections-content');
                    const contentRequests = document.getElementById('requests-content');

                    if(tabCollections && tabRequests){
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('tab') === 'requests') {
                            tabRequests.click();
                            tabRequests.classList.add('active'); tabCollections.classList.remove('active');
                            contentRequests.style.display = 'block'; contentCollections.style.display = 'none';
                        }
                        tabCollections.addEventListener('click', () => {
                            tabCollections.classList.add('active'); tabRequests.classList.remove('active');
                            contentCollections.style.display = 'block'; contentRequests.style.display = 'none';
                        });
                        tabRequests.addEventListener('click', () => {
                            tabRequests.classList.add('active'); tabCollections.classList.remove('active');
                            contentRequests.style.display = 'block'; contentCollections.style.display = 'none';
                        });
                    }

                    const tableBody = document.getElementById('admin-requests-table-body');
                    const filterType = document.getElementById('admin-filter-type');
                    const filterStatus = document.getElementById('admin-filter-status');

                    function renderTable(requests) {
                        if(!tableBody) return;
                        tableBody.innerHTML = '';
                        if (!requests || requests.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted p-3">No hay solicitudes que coincidan.</td></tr>';
                            return;
                        }
                        requests.forEach(req => {
                            let badgeClass = req.estado === 'PENDIENTE' ? 'bg-warning' : (req.estado.includes('ACEPT') ? 'bg-success' : 'bg-danger');

                            // CAMBIO 2: Botón SIEMPRE visible, cambiamos el texto según estado
                            let btnText = req.estado === 'PENDIENTE' ? 'Evaluar' : 'Ver Detalle';
                            let btnClass = req.estado === 'PENDIENTE' ? 'btn-primary' : 'btn-outline-secondary';

                            let actionBtn = `<button class="btn ${btnClass} btn-sm rounded-pill btn-view-detail"
                                     data-id="${req.id}"
                                     data-type="${req.tipo}"
                                     data-status="${req.estado}">
                                     <i class="bi bi-eye me-1"></i> ${btnText}</button>`;

                            tableBody.innerHTML += `<tr>
                        <td class="fw-bold">${req.tituloDelHechoAEliminar || 'Sin título'}</td>
                        <td><span class="badge bg-info text-dark">${req.tipo}</span></td>
                        <td><span class="badge ${badgeClass}">${req.estado}</span></td>
                        <td class="text-end">${actionBtn}</td>
                    </tr>`;
                        });
                    }

                    function applyFilters() {
                        const type = filterType.value;
                        const status = filterStatus.value;

                        const filtered = allRequests.filter(r => {
                            const estadoData = r.estado ? r.estado.toUpperCase() : 'PENDIENTE';

                            let statusMatch = true;

                            if (status) {
                                if (status === 'ACEPTADO' || status === 'APROBADA') {
                                    statusMatch = estadoData.includes('ACEPT') || estadoData.includes('APROB');
                                } else if (status === 'RECHAZADO' || status === 'RECHAZADA') {
                                    statusMatch = estadoData.includes('RECHAZ');
                                } else {
                                    statusMatch = estadoData === status;
                                }
                            }

                            return (!type || r.tipo === type) && statusMatch;
                        });

                        renderTable(filtered);
                    }

                    if(filterType && filterStatus) {
                        filterType.addEventListener('change', applyFilters);
                        filterStatus.addEventListener('change', applyFilters);
                        renderTable(allRequests);
                    }

                    // --- LÓGICA DEL MODAL ---
                    document.addEventListener('click', function(e) {
                        const btn = e.target.closest('.btn-view-detail');
                        if (btn) {
                            const id = btn.getAttribute('data-id');
                            const tipo = btn.getAttribute('data-type');
                            const estado = btn.getAttribute('data-status');
                            if (!id || id === 'null') { alert("Error: ID inválido."); return; }

                            const modalFooter = document.querySelector('#evaluationModal .modal-footer');

                            if (estado !== 'PENDIENTE') {
                                modalFooter.style.display = 'none';
                            } else {
                                modalFooter.style.display = 'flex'; // Mostrar si es pendiente
                            }

                            const modalTitle = document.getElementById('modalTitle');
                            const modalContent = document.getElementById('modalContent');
                            const formApprove = document.getElementById('formApprove');
                            const formReject = document.getElementById('formReject');

                            modalTitle.textContent = `Evaluando: ${tipo}`;
                            modalContent.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando detalles...</p></div>';

                            // Referencia al botón de sugerencia para ocultarlo/mostrarlo
                            const formSuggestion = document.getElementById('formApproveWithSuggestion');
                            const inputSugerenciaContainer = document.getElementById('sugerencia-container');

                            if(formSuggestion) formSuggestion.style.display = 'none';
                            if(inputSugerenciaContainer) inputSugerenciaContainer.style.display = 'none';

                            if (tipo === 'Nuevo Hecho') {
                                formApprove.action = `/admin/hechos/${id}/resolver?estado=ACEPTADO`;
                                formReject.action = `/admin/hechos/${id}/resolver?estado=RECHAZADO`;

                                if (formSuggestion) {
                                    formSuggestion.style.display = 'inline';
                                    if(inputSugerenciaContainer) inputSugerenciaContainer.style.display = 'block';

                                    formSuggestion.onsubmit = function(e) {
                                        e.preventDefault();
                                        const textoSugerencia = document.getElementById('inputSugerencia').value;
                                        this.action = `/admin/hechos/${id}/resolver?estado=ACEPTADO_CON_SUGERENCIAS&sugerencia=${encodeURIComponent(textoSugerencia)}`;
                                        this.submit();
                                    };
                                }

                            } else if (tipo === 'Eliminación') {
                                formApprove.action = `/admin/solicitudes/${id}/aprobar`;
                                formReject.action = `/admin/solicitudes/${id}/rechazar`;

                            } else if (tipo === 'Edición') {
                                formApprove.action = `/admin/ediciones/${id}/aceptar`;
                                formReject.action = `/admin/ediciones/${id}/rechazar`;
                            }

                            const modal = new bootstrap.Modal(document.getElementById('evaluationModal'));
                            modal.show();

                            fetch(`/admin/api/solicitudes/${id}/detalle?tipo=${encodeURIComponent(tipo)}`)
                                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                                .then(({ status, body }) => {
                                    if (status >= 400) throw new Error(body.error || "Error en el servidor");
                                    const data = body;

                                    const containerSugerencia = document.getElementById('sugerencia-container');
                                    const txtSugerencia = document.getElementById('inputSugerencia');

                                    txtSugerencia.value = '';
                                    txtSugerencia.readOnly = false;
                                    containerSugerencia.style.display = 'none';

                                    if (data.estado === 'PENDIENTE' && tipo === 'Nuevo Hecho') {
                                        containerSugerencia.style.display = 'block';
                                    } else if (data.estado === 'ACEPTADO_CON_SUGERENCIAS') {
                                        containerSugerencia.style.display = 'block';
                                        // Priorizamos sugerenciaAdmin que viene del DTO nuevo, sino detalle
                                        txtSugerencia.value = data.sugerenciaAdmin || data.detalle || '';
                                        txtSugerencia.readOnly = true; // Para que se vea que es histórico
                                    }

                                    let html = '';
                                    let mapsToInit = [];

                                    // --- 1. NUEVO HECHO ---
                                    if (tipo === 'Nuevo Hecho') {
                                        const fecha = data.fechaAcontecimiento ? new Date(data.fechaAcontecimiento).toLocaleString() : '-';

                                        // --- CORRECCIÓN DE URL DE IMAGEN ---
                                        let imgUrl = data.contenidoMultimedia;
                                        if (imgUrl && !imgUrl.startsWith('http')) {
                                            // Apuntamos al puerto 8082 donde configuramos el ResourceHandler
                                            imgUrl = `${GLOBAL_BACKEND_URL}/uploads/${imgUrl}`;
                                        }
                                        // -----------------------------------

                                        const imgHtml = imgUrl ?
                                            `<div class="mb-3 text-center p-2 bg-light rounded border">
                                                <img src="${imgUrl}" class="img-fluid rounded" style="max-height: 300px;"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                                <div style="display:none" class="text-muted small mt-1">
                                                    <i class="bi bi-file-earmark"></i> Error al cargar imagen
                                                </div>
                                            </div>`
                                            : `<div class="alert alert-secondary py-2 small text-center">No se adjuntó contenido multimedia.</div>`;

                                        html = `
                                           <div class="alert alert-info border-0 shadow-sm mb-3">Propuesta de creación</div>
                                           <h4 class="text-primary fw-bold mb-3">${data.titulo || 'Sin título'}</h4>
                                           <p class="lead fs-6">${data.descripcion || 'Sin descripción'}</p>
                                           ${imgHtml}
                                           <div class="row g-2 small text-muted mb-3">
                                               <div class="col-6"><strong>Categoría:</strong> <span class="badge bg-secondary">${data.categoria}</span></div>
                                               <div class="col-6"><strong>Fecha:</strong> ${fecha}</div>
                                           </div>
                                           <div class="card border-0">
                                               <div class="card-header bg-white fw-bold small text-muted">Ubicación</div>
                                               <div class="card-body p-0">
                                                   <div id="modal-map-container" style="height: 250px; width: 100%; background: #eee; border-radius: 0 0 8px 8px;"></div>
                                               </div>
                                           </div>`;

                                        if(data.latitud && data.longitud) {
                                            mapsToInit.push({ id: 'modal-map-container', lat: data.latitud, lng: data.longitud, popup: 'Ubicación' });
                                        }
                                    }

                                    // --- 2. ELIMINACIÓN ---
                                    else if (tipo === 'Eliminación') {
                                        html = `<div class="alert alert-danger border-0 shadow-sm mb-3">Solicitud de Baja</div><p>Se solicita eliminar: <strong>${data.nombreHecho}</strong></p><div class="card border-danger"><div class="card-body text-danger p-3"><strong>Motivo:</strong><br> ${data.motivo}</div></div>`;
                                    }

                                    // --- 3. EDICIÓN (Lógica Avanzada) ---
                                    else if (tipo === 'Edición') {
                                        const orig = data.original || {};
                                        const prop = data.propuesta || {};
                                        const isDiff = (a, b) => a !== b ? 'text-success fw-bold' : '';

                                        // FORMATEO DE FECHAS
                                        const formatF = (dateStr) => {
                                            if (!dateStr) return '-';
                                            return new Date(dateStr).toLocaleString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                                        };

                                        const fechaO = formatF(orig.fechaAcontecimiento);
                                        const fechaP = formatF(prop.fechaAcontecimientoPropuesta);

                                        // A) Comparación de ubicación
                                        const latO = parseFloat(orig.latitud); const lngO = parseFloat(orig.longitud);
                                        const latP = parseFloat(prop.latitudPropuesta); const lngP = parseFloat(prop.longitudPropuesta);
                                        const hasLocationChange = (latO !== latP) || (lngO !== lngP);

                                        // B) Imágenes
                                        const imgOrig = orig.contenidoMultimedia ?
                                            `<div class="mt-2"><small class="fw-bold text-muted">Multimedia Actual:</small><br><img src="${orig.contenidoMultimedia}" class="img-fluid rounded shadow-sm" style="max-height: 150px;" onerror="this.style.display='none';"></div>`
                                            : `<div class="mt-2 text-muted small">Sin multimedia original.</div>`;

                                        const imgProp = prop.contenidoMultimediaPropuesto ?
                                            `<div class="mt-2"><small class="fw-bold text-success">Nueva Imagen:</small><br><img src="${prop.contenidoMultimediaPropuesto}" class="img-fluid rounded shadow-sm" style="max-height: 150px;" onerror="this.style.display='none';"></div>`
                                            : `<div class="mt-2 text-muted small fst-italic border-top pt-1">Sin cambios en multimedia.</div>`;

                                        // C) HTML de comparación (CON FECHA)
                                        html = `
                                    <div class="alert alert-warning border-0 shadow-sm mb-3">Propuesta de Edición</div>
                                    <div class="row g-0 border rounded mb-3">
                                        <div class="col-6 border-end bg-light p-3">
                                            <h6 class="text-center text-muted small fw-bold text-uppercase">Original</h6>
                                            <div class="mb-2"><small class="fw-bold">Título:</small><div>${orig.titulo || '-'}</div></div>
                                            <div class="mb-2"><small class="fw-bold">Descripción:</small><div class="small">${orig.descripcion || '-'}</div></div>
                                            <div class="mb-2"><small class="fw-bold">Categoría:</small><div class="small">${orig.categoria || '-'}</div></div>
                                            <div class="mb-2"><small class="fw-bold">Fecha:</small><div class="small">${fechaO}</div></div>
                                            ${imgOrig}
                                        </div>
                                        <div class="col-6 bg-white p-3">
                                            <h6 class="text-center text-primary small fw-bold text-uppercase">Propuesta</h6>
                                            <div class="mb-2"><small class="fw-bold">Título:</small><div class="${isDiff(orig.titulo, prop.tituloPropuesto)}">${prop.tituloPropuesto || orig.titulo}</div></div>
                                            <div class="mb-2"><small class="fw-bold">Descripción:</small><div class="${isDiff(orig.descripcion, prop.descripcionPropuesta)} small">${prop.descripcionPropuesta || orig.descripcion}</div></div>
                                            <div class="mb-2"><small class="fw-bold">Categoría:</small><div class="${isDiff(orig.categoria, prop.categoriaPropuestaNombre)} small">${prop.categoriaPropuestaNombre || orig.categoria}</div></div>
                                            <div class="mb-2"><small class="fw-bold">Fecha:</small><div class="${isDiff(fechaO, fechaP)} small">${fechaP}</div></div>
                                            ${imgProp}
                                        </div>
                                    </div>`;

                                        // D) Lógica de Mapas (CON TÍTULOS)
                                        if (hasLocationChange) {
                                            html += `
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="card border-danger h-100">
                                                    <div class="card-header bg-danger text-white small fw-bold text-center">Ubicación Original</div>
                                                    <div class="card-body p-0"><div id="map-edicion-original" style="height: 200px; width: 100%;"></div></div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="card border-success h-100">
                                                    <div class="card-header bg-success text-white small fw-bold text-center">Ubicación Propuesta</div>
                                                    <div class="card-body p-0"><div id="map-edicion-propuesta" style="height: 200px; width: 100%;"></div></div>
                                                </div>
                                            </div>
                                        </div>`;

                                            if(!isNaN(latO)) mapsToInit.push({ id: 'map-edicion-original', lat: latO, lng: lngO, popup: 'Original' });
                                            if(!isNaN(latP)) mapsToInit.push({ id: 'map-edicion-propuesta', lat: latP, lng: lngP, popup: 'Propuesta' });

                                        } else {
                                            html += `
                                        <div class="alert alert-secondary d-flex align-items-center py-2 mt-3"><i class="bi bi-geo-alt me-2"></i> Sin cambios en la ubicación.</div>
                                        <div class="card border-0"><div class="card-header bg-white fw-bold small text-muted">Ubicación Actual</div>
                                        <div class="card-body p-0"><div id="map-edicion-unico" style="height: 200px; width: 100%;"></div></div></div>`;

                                            if(!isNaN(latO)) mapsToInit.push({ id: 'map-edicion-unico', lat: latO, lng: lngO, popup: 'Ubicación Actual' });
                                        }
                                    }

                                    modalContent.innerHTML = html;

                                    // --- Inicialización Diferida de Mapas ---
                                    if (mapsToInit.length > 0) {
                                        setTimeout(() => {
                                            mapsToInit.forEach(m => {
                                                const el = document.getElementById(m.id);
                                                if(el) {
                                                    const map = L.map(m.id).setView([m.lat, m.lng], 15);
                                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
                                                    L.marker([m.lat, m.lng]).addTo(map).bindPopup(`<b>${m.popup}</b>`).openPopup();
                                                    map.invalidateSize();
                                                }
                                            });
                                        }, 300);
                                    } else if (tipo === 'Nuevo Hecho' || (tipo === 'Edición' && mapsToInit.length === 0)) {
                                        // Fallback si no hay coords
                                        const containers = document.querySelectorAll('[id^="map-"], [id^="modal-map-"]');
                                        containers.forEach(c => c.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted small">Coordenadas no disponibles</div>');
                                    }

                                })
                                .catch(err => {
                                    console.error(err);
                                    modalContent.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i> ${err.message}</div>`;
                                });
                        }
                    });

                    // CSV Lógica (Se mantiene igual)
                    const csvImportForm = document.getElementById('csv-import-form');
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (csvImportForm && loadingOverlay) {
                        csvImportForm.addEventListener('submit', function(e) {
                            const fileInput = document.getElementById('csvFile');
                            const errorPlaceholder = document.getElementById('csv-validation-error-placeholder');
                            if(errorPlaceholder) errorPlaceholder.innerHTML = '';

                            if (!fileInput.files.length) {
                                if(errorPlaceholder) errorPlaceholder.innerHTML = '<div class="alert alert-danger" role="alert">Error: Por favor, selecciona un archivo CSV.</div>';
                                e.preventDefault(); return;
                            }
                            const fileName = fileInput.files[0].name;
                            if (!fileName.toLowerCase().endsWith('.csv')) {
                                if(errorPlaceholder) errorPlaceholder.innerHTML = '<div class="alert alert-danger" role="alert">Error: Solo se admiten archivos en formato CSV (.csv).</div>';
                                e.preventDefault(); return;
                            }
                            const modalElement = document.getElementById('csvImportModal');
                            const bootstrapModal = bootstrap.Modal.getInstance(modalElement);
                            if (bootstrapModal) bootstrapModal.hide();
                            loadingOverlay.style.display = 'flex';
                        });
                    }
                });

                document.querySelectorAll('.modal').forEach(m => {
                    document.body.appendChild(m);
                });

            </script>
        </div>
    </body>
</html>