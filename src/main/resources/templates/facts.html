<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle=${'Hechos de ' + coleccion.titulo}, content=~{::#main-content}, pageScripts=~{::#page-scripts})}">
<body>

<main class="container-fluid p-4" id="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a th:href="@{/}" class="btn btn-outline-secondary rounded-pill px-4 py-2 fw-bold">← Volver</a>
        <a th:href="@{/hechos/nuevo}" class="btn btn-primary rounded-pill px-4 py-2 fw-bold">+ Subir Hecho</a>
    </div>

    <div class="alert alert-info p-4 rounded-3 mb-4 border-0 shadow-sm">
        <h3 class="alert-heading fw-bold text-info-emphasis" th:text="${coleccion.titulo}"></h3>
        <p class="mb-1 text-info-emphasis" th:text="${coleccion.descripcion}"></p>
        <small class="d-block text-info-emphasis" th:if="${coleccion.algoritmoConsenso != null}">
            <i class="bi bi-check-circle-fill me-1"></i><strong>Consenso:</strong> <span th:text="${coleccion.algoritmoConsenso}"></span>
        </small>
        <small class="d-block text-info-emphasis mt-1">
            <i class="bi bi-hdd-network me-1"></i><strong>Fuentes:</strong>
            <span th:text="${#lists.isEmpty(coleccion.fuentes) ? 'No especificadas' : #strings.listJoin(coleccion.fuentes, ', ')}"></span>
        </small>
    </div>

    <form th:action="@{/facts}" method="get">

        <input type="hidden" name="handleId" th:value="${filtros.handleId}" />

        <div class="card mb-4 shadow-sm border-0 rounded-3 p-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="filter-date-from" class="form-label small text-muted">Fecha Desde</label>
                    <input type="date" id="filter-date-from" name="fechaDesde" class="form-control" th:value="${filtros.fechaDesde}">
                </div>
                <div class="col-md-3">
                    <label for="filter-date-to" class="form-label small text-muted">Fecha Hasta</label>
                    <input type="date" id="filter-date-to" name="fechaHasta" class="form-control" th:value="${filtros.fechaHasta}">
                </div>
                <div class="col-md-3">
                    <label for="filter-category" class="form-label small text-muted">Categoría</label>
                    <select id="filter-category" name="categoria" class="form-select">
                        <option value="">Todas</option>
                        <option th:each="cat : ${categorias}"
                                th:value="${cat}"
                                th:text="${cat}"
                                th:selected="${cat == filtros.categoria}">
                        </option>
                    </select>
                </div>
                <div class="col-md-3 d-grid">
                    <button type="submit" class="btn btn-primary fw-bold">
                        <i class="bi bi-filter me-2"></i>Filtrar
                    </button>
                </div>
            </div>
        </div>

        <h4 class="text-primary fw-bold mb-3">Hechos de la Colección</h4>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="flex-grow-1 me-3" style="max-width: 450px;">
                <input type="text" id="filter-title" name="titulo" class="form-control" placeholder="Buscar por título..." th:value="${filtros.titulo}">
            </div>
            <div class="d-flex gap-3">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="modo" id="nav-unrestricted" value="irrestricta"
                           th:checked="${filtros.modo == 'irrestricta'}"
                           onchange="this.form.submit()"><label class="btn btn-outline-secondary btn-sm" for="nav-unrestricted"><i class="bi bi-unlock me-2"></i>Irrestricta</label>

                    <input type="radio" class="btn-check" name="modo" id="nav-curated" value="curada"
                           th:checked="${filtros.modo == 'curada'}"
                           onchange="this.form.submit()"><label class="btn btn-outline-secondary btn-sm" for="nav-curated"><i class="bi bi-shield-check me-2"></i>Curada</label>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary btn-sm active" id="list-tab-btn"><i class="bi bi-list-ul me-2"></i>Lista</button>
                    <button type="button" class="btn btn-primary btn-sm" id="map-tab-btn"><i class="bi bi-map me-2"></i>Mapa</button>
                </div>
            </div>
        </div>
    </form>

    <div id="view-content">
        <div id="list-view"><div class="row g-4" id="facts-list-container"></div></div>
        <div id="map-view" style="display: none;"><div class="card shadow-sm border-0 rounded-3" style="height: 70vh;"><div id="map" style="height: 100%; border-radius: .4375rem;"></div></div></div>
    </div>

    <nav aria-label="Navegación de hechos" class="mt-4" th:if="${totalPaginas > 1}">
        <ul class="pagination justify-content-center">

            <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/facts(handleId=${filtros.handleId}, page=${paginaActual - 1}, titulo=${filtros.titulo}, categoria=${filtros.categoria}, fechaDesde=${filtros.fechaDesde}, fechaHasta=${filtros.fechaHasta}, modo=${filtros.modo})}">
                    Anterior
                </a>
            </li>

            <li class="page-item disabled">
                <span class="page-link text-dark">
                    Página <span th:text="${paginaActual + 1}"></span> de <span th:text="${totalPaginas}"></span>
                </span>
            </li>

            <li class="page-item" th:classappend="${paginaActual + 1 >= totalPaginas} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/facts(handleId=${filtros.handleId}, page=${paginaActual + 1}, titulo=${filtros.titulo}, categoria=${filtros.categoria}, fechaDesde=${filtros.fechaDesde}, fechaHasta=${filtros.fechaHasta}, modo=${filtros.modo})}">
                    Siguiente
                </a>
            </li>
        </ul>
    </nav>
</main>

<div id="page-scripts">
    <script th:inline="javascript">/*<![CDATA[*/ const allFacts = /*[[${hechos}]]*/ []; /*]]>*/</script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar('index');
            const map = L.map('map').setView([-40, -64], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            let markersLayer = L.layerGroup().addTo(map);
            const factsListContainer = document.getElementById('facts-list-container');

            function renderFactList(facts) {
                factsListContainer.innerHTML = '';
                if (facts.length === 0) {
                    factsListContainer.innerHTML = '<div class="col-12"><div class="card card-body text-center text-muted">No hay hechos que coincidan con los filtros.</div></div>';
                    return;
                }
                facts.forEach(fact => {
                    const factCard = `
        <div class="col-md-6 col-lg-4">
            <div data-fact-id="${fact.id}" class="card h-100 shadow-sm border-0 rounded-3 custom-card-hover fact-card" style="cursor: pointer;">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between mb-2">
                        <h6 class="card-title text-primary fw-bold">${fact.titulo}</h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light py-0 px-2" type="button" data-bs-toggle="dropdown" onclick="event.stopPropagation();">•••</button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/solicitudes/nueva?hechoId=${fact.id}">Solicitar Eliminación</a></li>
                            </ul>
                        </div>
                    </div>
                    <p class="card-text text-muted small flex-grow-1">${fact.descripcion}</p>
                    <div class="mt-auto pt-3 border-top">
                        <span class="badge bg-secondary me-2">${fact.categoria}</span>
                        <small class="text-muted">Fecha: ${new Date(fact.fechaAcontecimiento).toLocaleDateString('es-ES')}</small>
                    </div>
                </div>
            </div>
        </div>`;
                    factsListContainer.innerHTML += factCard;
                });
                addEventListenersToCards();

            }

            function renderMapMarkers(facts) {
                markersLayer.clearLayers();
                facts.forEach(fact => {
                    if (fact.latitud && fact.longitud) {
                        const marker = L.marker([fact.latitud, fact.longitud]).addTo(markersLayer);
                        const popupContent = `
                        <div class="p-1" style="min-width: 200px; max-width: 300px;">
                            <strong class="text-primary">${fact.titulo}</strong>
                            <p class="my-1 small text-muted">${fact.descripcion.substring(0, Math.min(fact.descripcion.length, 70))}...</p>
                            <small class="text-muted">${new Date(fact.fechaAcontecimiento).toLocaleDateString('es-ES')}</small>
                            <button class="btn btn-sm btn-outline-primary mt-2 w-100 open-fact-detail" data-fact-id="${fact.id}">Ver Detalles</button>
                        </div>`;
                        marker.bindPopup(popupContent);
                        marker.on('popupopen', (e) => {
                            const button = e.popup._container.querySelector('.open-fact-detail');
                            if (button) {
                                button.addEventListener('click', () => {
                                    const factId = button.getAttribute('data-fact-id');
                                    const factToShow = allFacts.find(f => f.id == factId);
                                    if (factToShow) {
                                        marker.closePopup();
                                        const modalEl = openModal(renderFactDetailModal, factToShow);
                                        if(modalEl) {
                                            modalEl.addEventListener('shown.bs.modal', () => {
                                                const miniMap = L.map('mini-map').setView([factToShow.latitud, factToShow.longitud], 13);
                                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
                                                L.marker([factToShow.latitud, factToShow.longitud]).addTo(miniMap);
                                            }, { once: true });
                                        }
                                    }
                                });
                            }
                        });
                    }
                });
            }

            function addEventListenersToCards() {
                document.querySelectorAll('.fact-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const factId = card.getAttribute('data-fact-id');
                        const factToShow = allFacts.find(f => f.id == factId);
                        if (factToShow) {
                            const modalEl = openModal(renderFactDetailModal, factToShow);
                            if(modalEl) {
                                modalEl.addEventListener('shown.bs.modal', () => {
                                    const miniMap = L.map('mini-map').setView([factToShow.latitud, factToShow.longitud], 13);
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
                                    L.marker([factToShow.latitud, factToShow.longitud]).addTo(miniMap);
                                }, { once: true });
                            }
                        }
                    });
                });
            }

            renderFactList(allFacts);
            renderMapMarkers(allFacts);

            const listTabBtn = document.getElementById('list-tab-btn');
            const mapTabBtn = document.getElementById('map-tab-btn');
            const listView = document.getElementById('list-view');
            const mapView = document.getElementById('map-view');
            listTabBtn.addEventListener('click', () => { listTabBtn.classList.add('active'); mapTabBtn.classList.remove('active'); listView.style.display = 'block'; mapView.style.display = 'none'; });
            mapTabBtn.addEventListener('click', () => { mapTabBtn.classList.add('active'); listTabBtn.classList.remove('active'); mapView.style.display = 'block'; listView.style.display = 'none'; setTimeout(() => map.invalidateSize(), 10); });
        });
    </script>
</div>
</body>
</html>