<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle=${titulo}, content=~{::#main-content}, pageScripts=~{::#page-scripts})}">
<body>

<main class="container-fluid p-4 animate__animated animate__fadeIn" id="main-content">
    <h3 class="fw-bold mb-4 text-primary" th:text="${titulo}"></h3>

    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-body p-4">

            <div th:if="${tieneEdicionPendiente}" class="alert alert-warning d-flex align-items-center shadow-sm mb-4" role="alert">
                <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                <div>
                    <strong>Edición en curso:</strong> Ya has enviado una solicitud de edición para este hecho que está pendiente de revisión.
                    <br>No puedes realizar nuevos cambios hasta que la anterior sea resuelta.
                </div>
            </div>

            <form th:object="${hechoDTO}"
                  th:action="${accion == 'crear'} ? @{/hechos/crear} : @{/hechos/{id}/editar(id=${hechoDTO.id})}"
                  method="post"
                  enctype="multipart/form-data">

                <p class="text-muted small">
                    Tu sugerencia será revisada por un administrador antes de ser pública.
                </p>

                <div class="mb-3">
                    <label for="titulo" class="form-label">Título</label>
                    <input type="text" id="titulo" class="form-control" th:field="*{titulo}" required placeholder="Ej: Incendio en reserva ecológica">
                </div>

                <div class="mb-3">
                    <label for="descripcion" class="form-label">Descripción</label>
                    <textarea id="descripcion" class="form-control" rows="4" th:field="*{descripcion}" required placeholder="Detalla qué sucedió..."></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="categoria" class="form-label">Categoría</label>
                        <select id="categoria" class="form-select" th:field="*{categoria}" required>
                            <option value="">Seleccione una categoría...</option>
                            <option th:each="cat : ${categorias}"
                                    th:value="${cat}"
                                    th:text="${cat}">
                            </option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="fechaAcontecimiento" class="form-label">Fecha del Hecho</label>
                        <input type="datetime-local" id="fechaAcontecimiento" class="form-control" th:field="*{fechaAcontecimiento}" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Ubicación (Haz clic en el mapa)</label>
                    <div id="map-selector" style="height: 400px; width: 100%; border-radius: 8px;" class="border"></div>
                    <div class="form-text text-primary" id="location-help">
                        <i class="bi bi-info-circle"></i> Haz clic en el mapa para marcar la ubicación exacta.
                    </div>

                    <div class="row mt-2 g-2">
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Lat</span>
                                <input type="number" step="any" id="latitud" class="form-control" th:field="*{latitud}" required readonly>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Long</span>
                                <input type="number" step="any" id="longitud" class="form-control" th:field="*{longitud}" required readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="archivo" class="form-label">Contenido Multimedia (Opcional)</label>
                    <input class="form-control" type="file" id="archivo" name="archivo" accept="image/*,video/*">
                    <div class="form-text">Imágenes o videos. Máx. 20MB.</div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a th:href="@{/contributor}" class="btn btn-secondary rounded-pill px-4">Cancelar</a>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold"
                            th:disabled="${tieneEdicionPendiente}">
                        <span th:text="${tieneEdicionPendiente} ? 'Edición Bloqueada' : (${accion == 'crear'} ? 'Enviar Sugerencia' : 'Guardar Cambios')"></span>
                    </button>
                </div>

            </form>
        </div>
    </div>
</main>

<div id="page-scripts">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar('index');

            // 1. Inicializar Mapa
            const defaultLat = -34.6037;
            const defaultLng = -58.3816;

            const latInput = document.getElementById('latitud');
            const lngInput = document.getElementById('longitud');

            let currentLat = parseFloat(latInput.value);
            let currentLng = parseFloat(lngInput.value);

            // CORRECCIÓN: Validar que no sea 0 (cero) ni NaN
            let hasLocation = currentLat && currentLng && currentLat !== 0 && currentLng !== 0;

            let initialCenter = [defaultLat, defaultLng];
            let initialZoom = 10;

            if (hasLocation) {
                initialCenter = [currentLat, currentLng];
                initialZoom = 15;
            }

            const map = L.map('map-selector').setView(initialCenter, initialZoom);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            let marker = null;

            if (hasLocation) {
                marker = L.marker(initialCenter).addTo(map);
            }

            // 2. Evento Click en Mapa
            // Solo permitimos mover el marcador si NO está bloqueada la edición
            // (Aunque el backend protege, esto mejora la UX para que no jueguen con el mapa si no pueden guardar)
            const isBlocked = document.querySelector('button[type="submit"]').disabled;

            if (!isBlocked) {
                map.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;

                    latInput.value = lat;
                    lngInput.value = lng;

                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        marker = L.marker([lat, lng]).addTo(map);
                    }
                });
            } else {
                // Si está bloqueado, quitamos el puntero de mano para indicar que no es interactivo
                document.getElementById('map-selector').style.cursor = 'default';
            }
        });
    </script>
</div>

</body>
</html>