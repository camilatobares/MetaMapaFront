<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(pageTitle=${titulo}, content=~{::#main-content}, pageScripts=~{::#page-scripts})}">
<body>

<main class="container-fluid p-4 animate__animated animate__fadeIn" id="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold mb-0 text-primary" th:text="${titulo}">Estadísticas</h3>
        <a th:href="@{/admin}" class="btn btn-outline-secondary rounded-pill px-4 py-2 fw-bold">
            ← Volver al Panel
        </a>
    </div>

    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-body p-4">

            <h4 class="fw-bold text-primary mb-3">Métricas Globales</h4>
            <div class="row g-4 mb-5">

                <div class="col-lg-6">
                    <div class="card card-body shadow-sm h-100 bg-white">
                        <h5 class="fw-bold text-secondary mb-3">Distribución de Hechos por Categoría</h5>

                        <div th:if="${distribucionCategorias?.distribucion != null and not #lists.isEmpty(distribucionCategorias.distribucion)}">
                            <canvas id="categoriaDoughnutChart" style="max-height: 350px;"></canvas>
                        </div>

                        <div th:unless="${distribucionCategorias?.distribucion != null and not #lists.isEmpty(distribucionCategorias.distribucion)}"
                             class="text-center text-muted p-5">
                            <i class="bi bi-pie-chart fs-1 d-block mb-2"></i>
                            No hay datos para el gráfico de Categorías.
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card card-body shadow-sm h-100 bg-white">
                        <h5 class="fw-bold text-secondary mb-3">Ratio de Solicitudes Spam (vs Total)</h5>

                        <div th:if="${spamRatio != null and spamRatio.totalSolicitudes != null and spamRatio.totalSolicitudes > 0}">
                            <canvas id="spamDoughnutChart" style="max-height: 350px;"></canvas>
                            <p class="text-center small text-muted mt-3">
                                Total de solicitudes procesadas:
                                <strong th:text="${spamRatio.totalSolicitudes}">0</strong>
                            </p>
                        </div>

                        <div th:unless="${spamRatio != null and spamRatio.totalSolicitudes != null and spamRatio.totalSolicitudes > 0}"
                             class="text-center text-muted p-5">
                            <i class="bi bi-shield-x fs-1 d-block mb-2"></i>
                            No hay suficientes datos de solicitudes para graficar.
                        </div>
                    </div>
                </div>

            </div>
            <h4 class="fw-bold text-primary mb-3 mt-4 border-top pt-4">Métricas dinámicas</h4>

            <div class="row g-4">

                <div class="col-12">
                    <div class="card shadow-sm border-0 rounded-3 p-3 bg-white">
                        <h5 class="fw-bold text-info mb-3"><i class="bi bi-geo-alt-fill me-2"></i>Distribución de hechos por Provincia según una Colección</h5>

                        <form th:action="@{/admin/estadisticas}" method="get" class="row g-3">
                            <input type="hidden" name="categoriaProvincia" th:value="${categoriaProvinciaSeleccionada}" th:if="${categoriaProvinciaSeleccionada}">
                            <input type="hidden" name="categoriaHora" th:value="${categoriaHoraSeleccionada}" th:if="${categoriaHoraSeleccionada}">

                            <div class="col-md-6">
                                <select id="handleIdColeccion" name="handleIdColeccion" class="form-select" required>
                                    <option value="">Seleccione una Colección...</option>
                                    <option th:each="col : ${colecciones}"
                                            th:value="${col.handleID}"
                                            th:text="${col.titulo}"
                                            th:selected="${col.handleID == handleIdColeccionSeleccionada}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 d-grid">
                                <button type="submit" class="btn btn-info fw-bold text-white">Consultar</button>
                            </div>
                        </form>

                        <div th:if="${resultadoProvinciaColeccion?.distribucion != null and not #lists.isEmpty(resultadoProvinciaColeccion.distribucion)}" class="mt-3">
                            <div class="card card-body bg-light">
                                <canvas id="provinciaColeccionBarChart" style="max-height: 450px;"></canvas>
                            </div>
                        </div>

                        <div th:if="${handleIdColeccionSeleccionada != null and (resultadoProvinciaColeccion?.distribucion == null or #lists.isEmpty(resultadoProvinciaColeccion.distribucion))}"
                             class="alert alert-warning mt-3">
                            <h6 class="alert-heading fw-bold mb-1">Sin Resultados:</h6>
                            <p class="mb-0">No se encontraron datos de distribución para esta colección.</p>
                        </div>

                        <div th:if="${errorProvinciaColeccion}" class="alert alert-danger mt-3" th:text="${errorProvinciaColeccion}"></div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card shadow-sm border-0 rounded-3 p-3 bg-white">
                        <h5 class="fw-bold text-success mb-3"><i class="bi bi-map-fill me-2"></i>Distribución de hechos por Provincia según una Categoría</h5>
                        <form th:action="@{/admin/estadisticas}" method="get" class="row g-3">
                            <input type="hidden" name="handleIdColeccion" th:value="${handleIdColeccionSeleccionada}" th:if="${handleIdColeccionSeleccionada}">
                            <input type="hidden" name="categoriaHora" th:value="${categoriaHoraSeleccionada}" th:if="${categoriaHoraSeleccionada}">

                            <div class="col-md-6">
                                <select id="categoriaProvincia" name="categoriaProvincia" class="form-select" required>
                                    <option value="">Seleccione una Categoría...</option>
                                    <option th:each="cat : ${categorias}"
                                            th:value="${cat}"
                                            th:text="${cat}"
                                            th:selected="${cat == categoriaProvinciaSeleccionada}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 d-grid">
                                <button type="submit" class="btn btn-success fw-bold text-white">Consultar</button>
                            </div>
                        </form>

                        <div th:if="${resultadoProvinciaCategoria?.distribucion != null and not #lists.isEmpty(resultadoProvinciaCategoria.distribucion)}" class="mt-3">
                            <div class="card card-body bg-light">
                                <canvas id="provinciaCategoriaBarChart" style="max-height: 450px;"></canvas>
                            </div>
                        </div>

                        <div th:if="${categoriaProvinciaSeleccionada != null and (resultadoProvinciaCategoria?.distribucion == null or #lists.isEmpty(resultadoProvinciaCategoria.distribucion))}"
                             class="alert alert-warning mt-3">
                            <h6 class="alert-heading fw-bold mb-1">Sin Resultados:</h6>
                            <p class="mb-0">No se encontraron datos para esta categoría.</p>
                        </div>

                        <div th:if="${errorProvinciaCategoria}" class="alert alert-danger mt-3" th:text="${errorProvinciaCategoria}"></div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card shadow-sm border-0 rounded-3 p-3 bg-white">
                        <h5 class="fw-bold text-warning mb-3"><i class="bi bi-clock-fill me-2"></i>Distribución de hechos por Hora según una Categoría</h5>
                        <form th:action="@{/admin/estadisticas}" method="get" class="row g-3">
                            <input type="hidden" name="handleIdColeccion" th:value="${handleIdColeccionSeleccionada}" th:if="${handleIdColeccionSeleccionada}">
                            <input type="hidden" name="categoriaProvincia" th:value="${categoriaProvinciaSeleccionada}" th:if="${categoriaProvinciaSeleccionada}">

                            <div class="col-md-6">
                                <select id="categoriaHora" name="categoriaHora" class="form-select" required>
                                    <option value="">Seleccione una Categoría...</option>
                                    <option th:each="cat : ${categorias}"
                                            th:value="${cat}"
                                            th:text="${cat}"
                                            th:selected="${cat == categoriaHoraSeleccionada}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6 d-grid">
                                <button type="submit" class="btn btn-warning fw-bold text-white">Consultar</button>
                            </div>
                        </form>

                        <div th:if="${resultadoHoraCategoria?.distribucion != null and not #lists.isEmpty(resultadoHoraCategoria.distribucion)}" class="mt-3">
                            <div class="card card-body bg-light">
                                <canvas id="horaLineChart" style="max-height: 450px;"></canvas>
                            </div>
                        </div>

                        <div th:if="${categoriaHoraSeleccionada != null and (resultadoHoraCategoria?.distribucion == null or #lists.isEmpty(resultadoHoraCategoria.distribucion))}"
                             class="alert alert-warning mt-3">
                            <h6 class="alert-heading fw-bold mb-1">Sin Resultados:</h6>
                            <p class="mb-0">No hay datos horarios para esta categoría.</p>
                        </div>

                        <div th:if="${errorHoraCategoria}" class="alert alert-danger mt-3" th:text="${errorHoraCategoria}"></div>
                    </div>
                </div>

            </div>
            <h4 class="fw-bold text-primary mb-3 mt-4 border-top pt-4">Exportación de Reportes</h4>
            <div class="row g-3 mb-5">
                <div class="col-md-6 col-lg-4">
                    <a th:href="${urlExportarProvinciaColeccion}" class="btn btn-outline-primary w-100 py-3 fw-bold rounded-3">
                        <i class="bi bi-download me-2"></i> Provincia por Colección - CSV
                    </a>
                </div>
                <div class="col-md-6 col-lg-4">
                    <a th:href="${urlExportarCategoriaHechos}" class="btn btn-outline-primary w-100 py-3 fw-bold rounded-3">
                        <i class="bi bi-download me-2"></i> Categoría Global - CSV
                    </a>
                </div>
                <div class="col-md-6 col-lg-4">
                    <a th:href="${urlExportarProvinciaCategoria}" class="btn btn-outline-primary w-100 py-3 fw-bold rounded-3">
                        <i class="bi bi-download me-2"></i> Provincia por Categoría - CSV
                    </a>
                </div>
                <div class="col-md-6 col-lg-4">
                    <a th:href="${urlExportarHoraCategoria}" class="btn btn-outline-primary w-100 py-3 fw-bold rounded-3">
                        <i class="bi bi-download me-2"></i> Hora por Categoría - CSV
                    </a>
                </div>
                <div class="col-md-6 col-lg-4">
                    <a th:href="${urlExportarSpam}" class="btn btn-outline-primary w-100 py-3 fw-bold rounded-3">
                        <i class="bi bi-download me-2"></i> Solicitudes Spam - CSV
                    </a>
                </div>
                <div class="col-md-6 col-lg-4">
                    <a th:href="${urlZipCompleto}" class="btn btn-primary w-100 py-3 fw-bold rounded-3">
                        <i class="bi bi-archive-fill me-2"></i> Exportar Reporte Completo - ZIP
                    </a>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="page-scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Inyección de datos de Thymeleaf a JS con protección de nulos
        const distribucionCategorias = /*[[${distribucionCategorias}]]*/ {};
        const spamRatio = /*[[${spamRatio}]]*/ {};
        const resultadoProvinciaColeccion = /*[[${resultadoProvinciaColeccion}]]*/ {};
        const resultadoProvinciaCategoria = /*[[${resultadoProvinciaCategoria}]]*/ {};
        const resultadoHoraCategoria = /*[[${resultadoHoraCategoria}]]*/ {};
        /*]]>*/
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Asegurar que renderSidebar exista (si no está en main.js, comentar esta línea)
            if (typeof renderSidebar === 'function') {
                renderSidebar('admin');
            }

            // Colores base
            const COLORS = {
                primary: 'rgba(0, 128, 128, 0.7)', // Teal
                primaryBorder: 'rgba(0, 128, 128, 1)',
                secondary: 'rgba(108, 117, 125, 0.7)',
                info: 'rgba(23, 162, 184, 0.7)',
                success: 'rgba(40, 167, 69, 0.7)',
                warning: 'rgba(255, 193, 7, 0.7)',
                danger: 'rgba(220, 53, 69, 0.7)',
                dangerBorder: 'rgba(220, 53, 69, 1)'
            };

            const PALETTE = [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                '#858796', '#5a5c69', '#00aba9', '#2b5797', '#e8c3b9'
            ];

            // --- GRÁFICO 1: Categorías (Doughnut) ---
            if (distribucionCategorias && distribucionCategorias.distribucion && distribucionCategorias.distribucion.length > 0) {
                const ctxCat = document.getElementById('categoriaDoughnutChart');
                if (ctxCat) {
                    new Chart(ctxCat, {
                        type: 'doughnut',
                        data: {
                            labels: distribucionCategorias.distribucion.map(d => d.categoria),
                            datasets: [{
                                data: distribucionCategorias.distribucion.map(d => d.cantidadHechos),
                                backgroundColor: PALETTE,
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'right' } } }
                    });
                }
            }

            // --- GRÁFICO 2: Spam (Doughnut) ---
            // CAMBIO IMPORTANTE AQUÍ: Calculamos el spamCount basándonos en el porcentaje
            if (spamRatio && spamRatio.totalSolicitudes > 0) {
                const total = spamRatio.totalSolicitudes;
                // El backend manda porcentaje y total, calculamos la cantidad absoluta de spam
                const spamCount = Math.round((total * spamRatio.porcentaje) / 100);
                const validCount = total - spamCount;

                const ctxSpam = document.getElementById('spamDoughnutChart');
                if (ctxSpam) {
                    new Chart(ctxSpam, {
                        type: 'doughnut',
                        data: {
                            labels: ['Spam Detectado', 'Solicitudes Válidas'],
                            datasets: [{
                                data: [spamCount, validCount],
                                backgroundColor: [COLORS.danger, COLORS.success],
                                borderColor: [COLORS.dangerBorder, '#fff'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: `Tasa de Spam: ${spamRatio.porcentaje}%` }
                            }
                        }
                    });
                }
            }

            // --- GRÁFICO 3: Provincia por Colección (Bar) ---
            if (resultadoProvinciaColeccion && resultadoProvinciaColeccion.distribucion && resultadoProvinciaColeccion.distribucion.length > 0) {
                const data = resultadoProvinciaColeccion.distribucion.sort((a, b) => b.cantidadHechos - a.cantidadHechos);
                const ctxProvCol = document.getElementById('provinciaColeccionBarChart');

                if (ctxProvCol) {
                    new Chart(ctxProvCol, {
                        type: 'bar',
                        data: {
                            labels: data.map(d => d.provincia),
                            datasets: [{
                                label: 'Hechos',
                                data: data.map(d => d.cantidadHechos),
                                backgroundColor: COLORS.info,
                                borderColor: COLORS.primaryBorder,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true
                        }
                    });
                }
            }

            // --- GRÁFICO 4: Provincia por Categoría (Bar) ---
            if (resultadoProvinciaCategoria && resultadoProvinciaCategoria.distribucion && resultadoProvinciaCategoria.distribucion.length > 0) {
                const data = resultadoProvinciaCategoria.distribucion.sort((a, b) => b.cantidadHechos - a.cantidadHechos);
                const ctxProvCat = document.getElementById('provinciaCategoriaBarChart');

                if (ctxProvCat) {
                    new Chart(ctxProvCat, {
                        type: 'bar',
                        data: {
                            labels: data.map(d => d.provincia),
                            datasets: [{
                                label: 'Hechos',
                                data: data.map(d => d.cantidadHechos),
                                backgroundColor: COLORS.success,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true
                        }
                    });
                }
            }

            // --- GRÁFICO 5: Hora por Categoría (Line) ---
            if (resultadoHoraCategoria && resultadoHoraCategoria.distribucion && resultadoHoraCategoria.distribucion.length > 0) {
                const horasLabels = Array.from({length: 24}, (_, i) => `${i}:00`);
                // Mapear datos a las 24 horas (llenar huecos con 0)
                const mapDatos = new Map(resultadoHoraCategoria.distribucion.map(i => [parseInt(i.hora), i.cantidadHechos]));
                const dataSeries = Array.from({length: 24}, (_, i) => mapDatos.get(i) || 0);

                const ctxHora = document.getElementById('horaLineChart');
                if (ctxHora) {
                    new Chart(ctxHora, {
                        type: 'line',
                        data: {
                            labels: horasLabels,
                            datasets: [{
                                label: 'Frecuencia',
                                data: dataSeries,
                                borderColor: '#ffc107',
                                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1 } }
                            }
                        }
                    });
                }
            }
        });
    </script>
</div>
</body>
</html>